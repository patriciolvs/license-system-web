<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adicionar Venda - Sistema de Gestão de Licenças</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4" id="title">Adicionar Venda</h1>
        <div class="mb-3">
            <label for="client_name" class="form-label">Nome do Cliente</label>
            <input type="text" class="form-control" id="client_name" required>
        </div>
        <div class="mb-3">
            <label for="device" class="form-label">Dispositivo</label>
            <input type="text" class="form-control" id="device" required>
        </div>
        <div class="mb-3">
            <label for="product" class="form-label">Produto</label>
            <select class="form-control" id="product" required>
                <option value="">Selecione...</option>
                <option value="Norton">Norton</option>
                <option value="Kaspersky">Kaspersky</option>
                <option value="Bitdefender">Bitdefender</option>
                <option value="McAfee">McAfee</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="email" class="form-label">E-mail Compra</label>
            <input type="email" class="form-control" id="email" required>
        </div>
        <div class="mb-3">
            <label for="activation_code" class="form-label">Código Ativação</label>
            <input type="text" class="form-control" id="activation_code" required>
        </div>
        <div class="mb-3">
            <label for="activation_date" class="form-label">Data Ativação</label>
            <input type="date" class="form-control" id="activation_date" required onchange="updateCalculatedFields()">
        </div>
        <div class="mb-3">
            <label for="expiration_date" class="form-label">Data Validade</label>
            <input type="date" class="form-control" id="expiration_date" required onchange="updateCalculatedFields()">
        </div>
        <div class="mb-3">
            <label for="license_value" class="form-label">Valor Licença (R$)</label>
            <input type="number" step="0.01" class="form-control" id="license_value" required onchange="updateCalculatedFields()">
        </div>
        <div class="mb-3">
            <label for="quantity" class="form-label">Quantidade</label>
            <input type="number" class="form-control" id="quantity" required onchange="updateCalculatedFields()">
        </div>
        <div class="mb-3">
            <label for="discount" class="form-label">Desconto (R$)</label>
            <input type="number" step="0.01" class="form-control" id="discount" required onchange="updateCalculatedFields()">
        </div>
        <div class="mb-3">
            <label for="days_to_expire" class="form-label">Dias para Expirar</label>
            <input type="number" class="form-control" id="days_to_expire" readonly>
        </div>
        <div class="mb-3">
            <label for="total_value" class="form-label">Valor Total (R$)</label>
            <input type="text" class="form-control" id="total_value" readonly>
        </div>
        <div class="mb-3">
            <label for="total_with_discount" class="form-label">Valor c/ Desconto (R$)</label>
            <input type="text" class="form-control" id="total_with_discount" readonly>
        </div>
        <div class="mb-3">
            <label for="unit_value_with_discount" class="form-label">Valor Unitário c/ Desc (R$)</label>
            <input type="text" class="form-control" id="unit_value_with_discount" readonly>
        </div>
        <div class="mb-3">
            <label for="daily_value" class="form-label">Valor Diário (R$)</label>
            <input type="text" class="form-control" id="daily_value" readonly>
        </div>
        <button class="btn btn-success w-100 mb-2" onclick="validateAndSave()">Salvar</button>
        <button class="btn btn-danger w-100" onclick="window.location.href='dashboard.html'">Cancelar</button>
    </div>
    <script src="scripts.js"></script>
    <script>
        // Carregar dados se for edição
        const urlParams = new URLSearchParams(window.location.search);
        const row = urlParams.get('row');
        if (row) {
            document.getElementById('title').innerText = 'Editar Venda';
            fetchSales().then(sales => {
                const sale = sales[row];
                document.getElementById('client_name').value = sale[0];
                document.getElementById('device').value = sale[1];
                document.getElementById('product').value = sale[2];
                document.getElementById('email').value = sale[3];
                document.getElementById('activation_code').value = sale[4];
                document.getElementById('activation_date').value = sale[5];
                document.getElementById('expiration_date').value = sale[6];
                document.getElementById('days_to_expire').value = sale[7];
                document.getElementById('license_value').value = sale[8];
                document.getElementById('quantity').value = sale[9];
                document.getElementById('total_value').value = parseFloat(sale[10]).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                document.getElementById('discount').value = sale[11];
                document.getElementById('total_with_discount').value = parseFloat(sale[12]).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                document.getElementById('unit_value_with_discount').value = parseFloat(sale[13]).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                document.getElementById('daily_value').value = parseFloat(sale[14]).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            });
        }

        function validateAndSave() {
            const clientName = document.getElementById('client_name').value;
            const device = document.getElementById('device').value;
            const product = document.getElementById('product').value;
            const email = document.getElementById('email').value;
            const activationCode = document.getElementById('activation_code').value;
            const activationDate = document.getElementById('activation_date').value;
            const expirationDate = document.getElementById('expiration_date').value;
            const licenseValue = document.getElementById('license_value').value;
            const quantity = document.getElementById('quantity').value;
            const discount = document.getElementById('discount').value;

            if (!clientName) return alert('Por favor, insira o nome do cliente.');
            if (!device) return alert('Por favor, informe o dispositivo.');
            if (!product) return alert('Por favor, selecione um produto.');
            if (!email || !email.includes('@')) return alert('Por favor, insira um e-mail válido.');
            if (!activationCode) return alert('Por favor, insira o código de ativação.');
            if (!activationDate) return alert('Por favor, insira a data de ativação.');
            if (!expirationDate) return alert('Por favor, insira a data de validade.');
            if (!licenseValue || parseFloat(licenseValue) <= 0) return alert('Por favor, insira um valor de licença válido (maior que 0).');
            if (!quantity || parseInt(quantity) <= 0) return alert('Por favor, insira uma quantidade válida (maior que 0).');
            if (!discount || parseFloat(discount) < 0) return alert('Por favor, insira um desconto válido (não negativo).');

            const activationDateObj = new Date(activationDate);
            const expirationDateObj = new Date(expirationDate);
            if (expirationDateObj <= activationDateObj) return alert('A data de validade deve ser posterior à data de ativação.');

            const sale = [
                clientName, device, product, email, activationCode, activationDate, expirationDate,
                parseInt(document.getElementById('days_to_expire').value),
                parseFloat(licenseValue), parseInt(quantity),
                parseFloat(document.getElementById('total_value').value.replace('R$ ', '').replace('.', '').replace(',', '.')),
                parseFloat(discount),
                parseFloat(document.getElementById('total_with_discount').value.replace('R$ ', '').replace('.', '').replace(',', '.')),
                parseFloat(document.getElementById('unit_value_with_discount').value.replace('R$ ', '').replace('.', '').replace(',', '.')),
                parseFloat(document.getElementById('daily_value').value.replace('R$ ', '').replace('.', '').replace(',', '.'))
            ];
            saveSale(sale, row ? parseInt(row) : null, () => {
                window.location.href = 'dashboard.html';
            });
        }
    </script>
</body>
</html>